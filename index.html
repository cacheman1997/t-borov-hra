<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√°borov√° Hra - √özem√≠</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="/lib/leaflet.css" />
    
    <style>
        body, html { height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; touch-action: manipulation; }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        /* UI Panels */
        .panel {
            position: absolute;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            width: 300px;
        }
        
        /* Admin Panel (Desktop/Tablet default) */
        #admin-panel {
            top: 60px; /* Moved down to avoid potential HTTPS warning */
            right: 10px;
            max-height: 80vh;
            overflow-y: auto;
            width: 350px;
            max-width: 90vw;
        }

        /* Player Action Panel (Mobile Bottom Sheet Style) */
        #player-panel {
            bottom: 0;
            left: 0;
            width: 100%;
            transform: none;
            border-radius: 16px 16px 0 0;
            padding: 20px;
            box-sizing: border-box;
            max-width: 100%;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            #admin-panel {
                top: auto;
                bottom: 0;
                right: 0;
                left: 0;
                width: 100%;
                max-width: 100%;
                max-height: 50vh;
                border-radius: 16px 16px 0 0;
            }

            /* Force leaderboard to be small on mobile too */
            #leaderboard-panel {
                top: 50px;
                left: 10px;
                width: 250px;
                max-width: 70vw;
                max-height: 40vh;
            }
            
            /* Move leaderboard button to TOP LEFT on mobile as icon */
            .leaderboard-toggle-btn {
                top: 70px; /* Below warning */
                left: 10px;
                bottom: auto; /* Reset bottom */
                width: 40px;
                height: 40px;
                border-radius: 50%;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                z-index: 2000;
            }
            /* Hide text on mobile, show only icon */
            .leaderboard-toggle-btn span {
                display: none;
            }

            .btn {
                padding: 12px 20px; /* Larger touch target */
                font-size: 16px;
                margin-bottom: 8px;
            }

            .login-box {
                width: 90%;
                padding: 1.5rem;
            }
            
            h2, h3 { margin-top: 0; }
        }

        /* Overlays */
        #login-overlay, #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        #loading-overlay { display: none; color: white; flex-direction: column; text-align: center; padding: 20px; }

        .login-box {
            background: white; padding: 2rem; border-radius: 12px;
            width: 100%; max-width: 320px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .btn {
            background: #2c3e50; color: white; border: none;
            padding: 12px 24px; border-radius: 8px; cursor: pointer;
            margin: 5px; width: 100%; font-size: 16px;
            font-weight: 600;
            transition: background 0.2s, transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn.green { background: #27ae60; }
        .btn.red { background: #c0392b; }
        .btn:disabled { background: #95a5a6; cursor: not-allowed; }

        input, select, textarea {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;
            font-size: 16px; /* Prevents iOS zoom */
            background: #f9f9f9;
        }

        .request-item {
            border: 1px solid #eee; padding: 12px; margin-bottom: 10px;
            border-radius: 8px; background: #f8f9fa;
        }
        .request-item h4 { margin: 0 0 5px 0; font-size: 1.1em; }
        
        .label-icon {
            background: rgba(0,0,0,0.8); color: white; border: 2px solid white;
            border-radius: 50%; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }
        .label-icon.locked {
            background: #c0392b; /* Red background for locked */
            font-size: 14px;
        }
        .leaflet-tooltip.label-icon::before { display: none; }

        /* Leaderboard */
        #leaderboard-panel {
            position: absolute;
            top: 60px; /* Below the warning if present, or just below top */
            left: 10px;
            width: 300px;
            max-width: 80%; /* Don't cover full width on small screens */
            height: auto;
            max-height: 50vh; /* Only half height */
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 11000;
            border-radius: 12px;
            display: none; /* Hidden by default, toggle with button */
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        #leaderboard-panel.open {
            display: block;
        }
        .leaderboard-toggle-btn {
            position: fixed;
            top: 20px; /* Moved back to top, let's try right side for mobile */
            left: 20px;
            z-index: 1500;
            background: #2c3e50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50px; /* Pill shape */
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .leaderboard-table th, .leaderboard-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .leaderboard-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .team-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        /* HTTPS Warning */
        #https-warning {
            display: none;
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #ffeeba;
            position: fixed;
            top: 0; left: 0; width: 100%;
            z-index: 10000;
            font-size: 14px;
        }
        /* Leaderboard Tabs */
        .leaderboard-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        .tab-btn {
            flex: 1;
            padding: 8px 4px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: bold;
            color: #7f8c8d;
            font-size: 13px;
        }
        .tab-btn.active {
            border-bottom-color: #2c3e50;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div id="https-warning">
        ‚ö†Ô∏è Pozor: Pro spr√°vnou funkƒçnost GPS je nutn√© hr√°t p≈ôes HTTPS (nebo localhost). Na bƒõ≈æn√©m HTTP p≈ôipojen√≠ nebude lokalizace fungovat.
        <button onclick="document.getElementById('https-warning').style.display='none'" style="margin-left:10px;border:none;background:none;cursor:pointer;">‚úñ</button>
    </div>

    <!-- Login -->
    <div id="login-overlay">
        <div class="login-box">
            <h2>P≈ôihl√°≈°en√≠</h2>
            <select id="team-select">
                <option value="" disabled selected>Vyberte t√Ωm...</option>
                <optgroup label="T√Ωmy">
                    <option value="cerveni">ƒåerven√≠</option>
                    <option value="modri">Mod≈ô√≠</option>
                    <option value="zeleni">Zelen√≠</option>
                    <option value="zluti">≈Ωlut√≠</option>
                    <option value="oranzovi">Oran≈æov√≠</option>
                    <option value="fialovi">Fialov√≠</option>
                </optgroup>
                <optgroup label="Spr√°va">
                    <option value="admin">Admin</option>
                </optgroup>
            </select>
            <input type="password" id="password" placeholder="Heslo">
            <button class="btn" onclick="handleLogin()">Vstoupit</button>
            <p id="login-error" style="color:red;display:none;"></p>
        </div>
    </div>

    <!-- Loading / Status Overlay -->
    <div id="loading-overlay">
        <h3 id="loading-text">ƒåek√°m na odpovƒõƒè admina...</h3>
        <div class="loader"></div>
        <button id="cancel-loading-btn" class="btn red" style="margin-top:20px; max-width:200px;" onclick="cancelMyRequest()">Zru≈°it ≈æ√°dost</button>
    </div>

    <!-- Leaderboard UI -->
    <button class="leaderboard-toggle-btn" onclick="toggleLeaderboard()">üèÜ <span>≈Ωeb≈ô√≠ƒçek</span></button>
    
    <div id="leaderboard-panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>≈Ωeb≈ô√≠ƒçek</h2>
            <button onclick="toggleLeaderboard()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;">&times;</button>
        </div>
        
        <div class="leaderboard-tabs">
            <button class="tab-btn active" onclick="switchTab('final')">Fin√°le</button>
            <button class="tab-btn" onclick="switchTab('count')">Poƒçet</button>
            <button class="tab-btn" onclick="switchTab('time')">ƒåas</button>
        </div>

        <div id="tab-final" class="tab-content" style="display:block;">
            <p style="font-size:12px;margin:5px 0;"><strong>Fin√°ln√≠ po≈ôad√≠</strong> (pr≈Ømƒõr um√≠stƒõn√≠):</p>
            <table class="leaderboard-table">
                <thead><tr><th>T√Ωm</th><th>Pr≈Ømƒõr</th></tr></thead>
                <tbody id="leaderboard-body-final"></tbody>
            </table>
        </div>

        <div id="tab-count" class="tab-content" style="display:none;">
            <p style="font-size:12px;margin:5px 0;"><strong>Poƒçet</strong> zabran√Ωch √∫zem√≠:</p>
            <table class="leaderboard-table">
                <thead><tr><th>T√Ωm</th><th>Ks</th></tr></thead>
                <tbody id="leaderboard-body-count"></tbody>
            </table>
        </div>

        <div id="tab-time" class="tab-content" style="display:none;">
            <p style="font-size:12px;margin:5px 0;"><strong>Celkov√Ω ƒças</strong> dr≈æen√≠:</p>
            <table class="leaderboard-table">
                <thead><tr><th>T√Ωm</th><th>ƒåas</th></tr></thead>
                <tbody id="leaderboard-body-time"></tbody>
            </table>
        </div>
    </div>

    <div id="map"></div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="panel">
        <h3>P≈ô√≠choz√≠ ≈æ√°dosti</h3>
        <button class="btn red" style="margin-bottom: 10px; width: 100%; font-size: 12px;" onclick="clearAllRequests()">Vyƒçistit v≈°echny ≈æ√°dosti</button>
        <div id="requests-list">
            <!-- Requests will appear here -->
            <p style="color:#7f8c8d; font-style:italic;">≈Ω√°dn√© aktivn√≠ ≈æ√°dosti.</p>
        </div>
    </div>

    <!-- Player Action Panel -->
    <div id="player-panel" class="panel">
        <h3 id="player-panel-title">√özem√≠</h3>
        <div id="player-content"></div>
    </div>

    <!-- Task Assignment Modal -->
    <div id="task-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:10001; box-shadow: 0 0 20px rgba(0,0,0,0.5); background: white; padding: 2rem; border-radius: 8px; width: 100%; max-width: 320px; text-align: center;">
        <h3>Zadat √∫kol</h3>
        <textarea id="task-input" rows="4" style="width:100%;" placeholder="Napi≈°te zad√°n√≠ √∫kolu..."></textarea>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn green" onclick="confirmTask()">Odeslat</button>
            <button class="btn red" onclick="closeTaskModal()">Zru≈°it</button>
        </div>
    </div>

    <div id="modal-backdrop" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000;" onclick="closeTaskModal()"></div>

    <!-- Sounds -->
    <audio id="sound-moo" src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_c8c8a73467.mp3?filename=cow-moo-1744.mp3" preload="auto"></audio>

    <!-- Libs -->
    <script src="/lib/leaflet.js"></script>
    <script src="/lib/polylabel.js"></script>
    <script src="/lib/socket.io.min.js"></script>

    <script>
        // Check for HTTPS/Secure Context
        if (!window.isSecureContext && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
            document.getElementById('https-warning').style.display = 'block';
        }

        const socket = io();
        let currentUser = null;
        let currentRole = null; // 'admin' or 'team'
        let currentTerritory = null; // Currently selected territory ID
        let myRequest = null; // Current active request for this team
        
        // Markers
        let myLocationMarker = null;
        let adminRequestMarkers = {}; // { reqId: marker }
        
        // Global state for scoring
        let globalTerritories = {};
        let globalScores = {}; // Historical scores from server
        let territoryLabels = {}; // { territoryId: marker }
        let currentReqIdForTask = null;
        
        // Team Colors Helper
        const teamColors = {
            'cerveni': '#e74c3c', 'modri': '#3498db', 'zeleni': '#2ecc71',
            'zluti': '#f1c40f', 'oranzovi': '#e67e22', 'fialovi': '#9b59b6',
            'bil√≠': '#ecf0f1'
        };
        const teamNames = {
             'cerveni': 'ƒåerven√≠', 'modri': 'Mod≈ô√≠', 'zeleni': 'Zelen√≠',
             'zluti': '≈Ωlut√≠', 'oranzovi': 'Oran≈æov√≠', 'fialovi': 'Fialov√≠',
             'bil√≠': 'B√≠l√≠'
        };

        // --- Socket Events ---

        socket.on('connect', () => {
            console.log("Connected to server");
        });

        // Login Response
        socket.on('login_response', (data) => {
            if (data.success) {
                currentUser = data.teamId;
                currentRole = data.role;
                
                document.getElementById('login-overlay').style.display = 'none';
                
                // Join socket room
                socket.emit('join_game', { role: currentRole, teamId: currentUser });

                if (currentRole === 'admin') {
                    document.getElementById('admin-panel').style.display = 'block';
                }
            } else {
                document.getElementById('login-error').innerText = data.message;
                document.getElementById('login-error').style.display = 'block';
            }
        });

        // Admin: Receive new request
        socket.on('new_request', (req) => {
            if(currentRole === 'admin') {
                renderAdminRequests([req], true);
                addAdminMarker(req);
                // Auto-zoom to the new request
                map.setView([req.lat, req.lng], 18);
                
                // Play sound
                try {
                    const audio = document.getElementById('sound-moo');
                    audio.currentTime = 0;
                    audio.play().catch(e => console.warn("Audio play blocked", e));
                } catch(e) { console.error(e); }
            }
        });

        // Admin: Receive init state
        socket.on('init_state', (data) => {
            if(currentRole === 'admin') {
                const reqs = Object.values(data.requests);
                // Sort by timestamp (oldest first) to ensure correct order
                reqs.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                
                renderAdminRequests(reqs, false);
                // Add markers for existing requests
                reqs.forEach(req => addAdminMarker(req));
                updateMapColors(data.territories);
                updateTerritoryLabels();
            }
            if(data.territories) {
                globalTerritories = data.territories;
                if(data.scores) globalScores = data.scores; // Load historical scores
                updateLeaderboardUI();
                updateTerritoryLabels();
            }
        });

        // Init scores for normal user
        socket.on('init_scores', (scores) => {
             globalScores = scores;
             updateLeaderboardUI();
        });

        // Admin: Request updated
        socket.on('request_updated', (req) => {
             if(currentRole === 'admin') updateAdminRequestUI(req);
        });
        
        // Admin: Request removed
        socket.on('request_removed', (data) => {
             if(currentRole === 'admin') {
                 const el = document.getElementById(`req-${data.reqId}`);
                 if(el) el.remove();
                 
                 // Remove marker
                 if(adminRequestMarkers[data.reqId]) {
                     map.removeLayer(adminRequestMarkers[data.reqId]);
                     delete adminRequestMarkers[data.reqId];
                 }
             }
        });

        // Admin: Task Response Received
        socket.on('task_response_received', (req) => {
            if(currentRole === 'admin') updateAdminRequestUI(req);
        });

        // Team: Location Verification Result
        socket.on('location_verification_result', (data) => {
            hideLoading();
            if (data.approved) {
                showTaskUI(data.taskText, data.reqId);
            } else {
                alert("Admin va≈°i polohu zam√≠tl. Zkuste to znovu.");
                myRequest = null;
            }
        });

        // Team: Task Result
        socket.on('task_result', (data) => {
            hideLoading();
            if (data.approved) {
                alert(`Gratulujeme! √özem√≠ ${data.territoryId} je va≈°e!`);
                document.getElementById('player-panel').style.display = 'none';
            } else {
                alert("√ökol nebyl splnƒõn (zam√≠tnuto adminem). Zkuste to znovu.");
                // Hide player panel if rejected
                document.getElementById('player-panel').style.display = 'none';
                document.getElementById('player-content').innerHTML = '';
            }
            myRequest = null;
        });

        // Global: Map Update
        socket.on('map_update', (territories) => {
            globalTerritories = territories;
            updateMapColors(territories);
            updateTerritoryLabels();
            updateLeaderboardUI();
        });

        // Fix: Listen for game_state_update
        socket.on('game_state_update', (data) => {
             if (data.territories) {
                globalTerritories = data.territories;
                if(data.scores) globalScores = data.scores; // Sync scores
                updateMapColors(data.territories);
                updateTerritoryLabels();
                updateLeaderboardUI();
             }
        });

        // Polling every 10 seconds
        setInterval(() => {
            if (currentUser) {
                socket.emit('request_map_update');
            }
        }, 10000);

        socket.on('error_message', (data) => {
            alert(data.message);
        });

        socket.on('request_cancelled_confirmation', () => {
            hideLoading();
            document.getElementById('player-panel').style.display = 'none';
            document.getElementById('player-content').innerHTML = '';
            
            // Remove my marker if exists
            if (myLocationMarker) {
                map.removeLayer(myLocationMarker);
                myLocationMarker = null;
            }
            
            myRequest = null;
            alert("≈Ω√°dost byla zru≈°ena.");
        });

        // --- Leaderboard Logic ---
        
        function toggleLeaderboard() {
            const panel = document.getElementById('leaderboard-panel');
            if (panel.style.display === 'block' || panel.classList.contains('open')) {
                panel.style.display = 'none';
                panel.classList.remove('open');
            } else {
                panel.style.display = 'block';
                panel.classList.add('open');
            }
        }

        function switchTab(tabName) {
            // Hide all
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            // Show target
            document.getElementById('tab-' + tabName).style.display = 'block';
            
            // Activate button
            const btns = document.querySelectorAll('.tab-btn');
            if(tabName === 'final') btns[0].classList.add('active');
            if(tabName === 'count') btns[1].classList.add('active');
            if(tabName === 'time') btns[2].classList.add('active');
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        function updateLeaderboardUI() {
            const timeScores = {};
            const countScores = {};
            const teamList = Object.keys(teamNames);
            const now = Date.now() / 1000;

            // Init
            teamList.forEach(team => {
                timeScores[team] = globalScores[team] || 0;
                countScores[team] = 0;
            });

            // Calculate current stats
            for (const tId in globalTerritories) {
                const t = globalTerritories[tId];
                if (t.owner) {
                    // Count
                    countScores[t.owner] = (countScores[t.owner] || 0) + 1;
                    
                    // Time (Current session)
                    if (t.capturedAt) {
                         const duration = now - t.capturedAt;
                         if (duration > 0) {
                             timeScores[t.owner] = (timeScores[t.owner] || 0) + duration;
                         }
                    }
                }
            }

            // Rank by Time
            const timeRanked = [...teamList].sort((a, b) => timeScores[b] - timeScores[a]);
            const timeRanks = {};
            timeRanked.forEach((team, index) => timeRanks[team] = index + 1);

            // Rank by Count
            const countRanked = [...teamList].sort((a, b) => countScores[b] - countScores[a]);
            const countRanks = {};
            countRanked.forEach((team, index) => countRanks[team] = index + 1);

            // Final Rank (Average placement)
            const finalScores = {};
            teamList.forEach(team => {
                finalScores[team] = (timeRanks[team] + countRanks[team]) / 2;
            });
            const finalRanked = [...teamList].sort((a, b) => finalScores[a] - finalScores[b]); // Lower is better

            // Render Tables
            renderTable('leaderboard-body-final', finalRanked, finalScores, '', true);
            renderTable('leaderboard-body-count', countRanked, countScores, '');
            renderTable('leaderboard-body-time', timeRanked, timeScores, '', false, true);
        }

        function renderTable(tbodyId, rankedTeams, scoresObj, suffix, isAvg = false, isTime = false) {
            const tbody = document.getElementById(tbodyId);
            if(!tbody) return;
            tbody.innerHTML = '';

            rankedTeams.forEach((team, index) => {
                let valStr = scoresObj[team];
                if(isTime) valStr = formatTime(valStr);
                else if(isAvg) valStr = valStr.toFixed(1); // 1 decimal for average
                
                const row = document.createElement('tr');
                // Highlight top 3
                let medal = '';
                if(index === 0) medal = 'ü•á ';
                if(index === 1) medal = 'ü•à ';
                if(index === 2) medal = 'ü•â ';

                row.innerHTML = `
                    <td>
                        ${medal}
                        <span class="team-dot" style="background-color: ${teamColors[team] || '#ccc'}"></span>
                        ${teamNames[team] || team}
                    </td>
                    <td style="font-family:monospace; font-weight:bold;">${valStr}${suffix}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update leaderboard every second to animate the timer
        setInterval(() => {
            updateLeaderboardUI();
            updateTerritoryLabels();
        }, 1000);

        // --- UI Logic ---

        function handleLogin() {
            const team = document.getElementById('team-select').value;
            const pwd = document.getElementById('password').value;
            
            if (!team) return;
            
            socket.emit('login_request', { teamId: team, password: pwd });
        }

        function showLoading(text) {
            document.getElementById('loading-text').innerText = text;
            document.getElementById('loading-overlay').style.display = 'flex';
            
            // Only show cancel button if it's a request, not general loading
            if (text.includes("GPS")) {
                 document.getElementById('cancel-loading-btn').style.display = 'none';
            } else {
                 document.getElementById('cancel-loading-btn').style.display = 'block';
            }
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function cancelMyRequest() {
            if (confirm("Opravdu chcete zru≈°it aktu√°ln√≠ ≈æ√°dost?")) {
                socket.emit('cancel_request', { teamId: currentUser });
            }
        }

        // --- Player Flow ---

        function requestLocationCheck(territoryId) {
            if (myRequest) {
                alert("M√°te ji≈æ aktivn√≠ ≈æ√°dost!");
                return;
            }

            if (!navigator.geolocation) {
                alert("V√°≈° prohl√≠≈æeƒç nepodporuje geolokaci.");
                return;
            }

            showLoading("Z√≠sk√°v√°m GPS polohu...");
            
            navigator.geolocation.getCurrentPosition((pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                
                // Show player marker
                if (myLocationMarker) map.removeLayer(myLocationMarker);
                myLocationMarker = L.circleMarker([lat, lng], {
                    radius: 10,
                    fillColor: "#3388ff",
                    color: "#fff",
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                
                // Zoom to location so user sees it
                map.setView([lat, lng], 18);

                showLoading("ƒåek√°m na schv√°len√≠ adminem...");
                
                socket.emit('request_location_check', {
                    teamId: currentUser,
                    lat: lat,
                    lng: lng,
                    territoryId: territoryId
                });
                
                myRequest = { territoryId: territoryId, status: 'pending' };

            }, (err) => {
                hideLoading();
                alert("Chyba GPS: " + err.message);
            });
        }

        function showTaskUI(taskText, reqId) {
            const panel = document.getElementById('player-panel');
            const content = document.getElementById('player-content');
            
            panel.style.display = 'block';
            document.getElementById('player-panel-title').innerText = "√ökol";
            
            content.innerHTML = `
                <p><strong>Zad√°n√≠:</strong> ${taskText}</p>
                <textarea id="task-answer" placeholder="Napi≈°te odpovƒõƒè..."></textarea>
                <input type="file" id="task-file" accept="image/*,video/*">
                <div style="display:flex; gap:5px;">
                    <button class="btn green" onclick="submitTask('${reqId}')">Odeslat odpovƒõƒè</button>
                    <button class="btn red" onclick="cancelMyRequest()">Vzd√°t to</button>
                </div>
            `;
        }

        async function submitTask(reqId) {
            const text = document.getElementById('task-answer').value;
            const fileInput = document.getElementById('task-file');
            
            let filename = null;

            if (fileInput.files.length > 0) {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                
                try {
                    const res = await fetch('/upload', { method: 'POST', body: formData });
                    const data = await res.json();
                    if (res.ok) filename = data.filename;
                } catch (e) {
                    console.error("Upload failed", e);
                    alert("Chyba p≈ôi nahr√°v√°n√≠ souboru");
                    return;
                }
            }

            if (!text && !filename) {
                alert("Vypl≈àte odpovƒõƒè nebo nahrajte soubor.");
                return;
            }

            showLoading("Odes√≠l√°m odpovƒõƒè ke kontrole...");
            socket.emit('submit_task_response', {
                reqId: reqId,
                responseType: filename ? 'file' : 'text',
                content: filename || text
            });
        }

        // --- Admin Flow ---

        function renderAdminRequests(requests, append) {
            const list = document.getElementById('requests-list');
            if (!append) list.innerHTML = '';
            
            if (requests.length === 0 && !append && list.children.length === 0) {
                list.innerHTML = '<p style="color:#7f8c8d; font-style:italic;">≈Ω√°dn√© aktivn√≠ ≈æ√°dosti.</p>';
                return;
            }

            requests.forEach(req => {
                // If it exists, update it instead
                if (document.getElementById(`req-${req.id}`)) {
                    updateAdminRequestUI(req);
                    return;
                }
                
                const div = document.createElement('div');
                div.id = `req-${req.id}`;
                div.className = 'request-item';
                div.innerHTML = getRequestHTML(req);
                list.appendChild(div);
            });
        }

        function updateAdminRequestUI(req) {
            const el = document.getElementById(`req-${req.id}`);
            if (el) el.innerHTML = getRequestHTML(req);
        }

        function getRequestHTML(req) {
            let timeStr = "";
            if (req.timestamp) {
                const date = new Date(req.timestamp * 1000);
                timeStr = `<span style="font-size:0.8em; color:#999; float:right;">${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}</span>`;
            }

            let html = `<h4>T√Ωm: ${req.teamId} (√özem√≠ ${req.territoryId}) ${timeStr}</h4>`;
            
            if (req.status === 'pending') {
                html += `
                    <p>Lokace: ${req.lat.toFixed(5)}, ${req.lng.toFixed(5)}</p>
                    <button class="btn green" onclick="approveLocation('${req.id}')">Schv√°lit polohu</button>
                    <button class="btn red" onclick="rejectLocation('${req.id}')">Zam√≠tnout</button>
                `;
            } else if (req.status === 'task_response_pending') {
                html += `<p><em>ƒåek√°m na vypracov√°n√≠ √∫kolu...</em></p>`;
            } else if (req.status === 'review_pending') {
                html += `<p><strong>Odpovƒõƒè:</strong></p>`;
                if (req.response.content && req.response.responseType === 'file') {
                    // Check extension
                    if (req.response.content.match(/\.(jpg|jpeg|png|gif)$/i)) {
                        html += `<img src="/uploads/${req.response.content}" style="max-width:100%;border-radius:4px;">`;
                    } else {
                        html += `<a href="/uploads/${req.response.content}" target="_blank">St√°hnout soubor</a>`;
                    }
                } else {
                    html += `<p>${req.response.content}</p>`;
                }
                html += `
                    <button class="btn green" onclick="approveTask('${req.id}', true)">Splnƒõno (Zabrat)</button>
                    <button class="btn red" onclick="approveTask('${req.id}', false)">Nesplnƒõno</button>
                `;
            }
            return html;
        }

        window.approveLocation = (reqId) => {
            currentReqIdForTask = reqId;
            document.getElementById('task-input').value = "Vyfo≈•te se u stromu."; // Default text
            document.getElementById('task-modal').style.display = 'block';
            document.getElementById('modal-backdrop').style.display = 'block';
        };

        window.closeTaskModal = () => {
            document.getElementById('task-modal').style.display = 'none';
            document.getElementById('modal-backdrop').style.display = 'none';
            currentReqIdForTask = null;
        };

        window.confirmTask = () => {
            const task = document.getElementById('task-input').value;
            if (task && currentReqIdForTask) {
                socket.emit('admin_verify_location', { reqId: currentReqIdForTask, approved: true, taskText: task });
                closeTaskModal();
            } else {
                alert("Zadejte text √∫kolu!");
            }
        };

        window.rejectLocation = (reqId) => {
            if(confirm("Opravdu zam√≠tnout?")) {
                socket.emit('admin_verify_location', { reqId, approved: false });
            }
        };

        window.approveTask = (reqId, approved) => {
            console.log("Approving task:", reqId, approved);
            socket.emit('admin_verify_task', { reqId: reqId, approved: approved });
        };

        function addAdminMarker(req) {
            if(req.status === 'pending' || req.status === 'task_response_pending' || req.status === 'review_pending') {
                // If exists, update or don't duplicate. 
                // Better to remove and re-add to ensure style update if needed, but let's just check existence.
                if(adminRequestMarkers[req.id]) return;

                const color = teamColors[req.teamId] || '#333';

                const marker = L.circleMarker([req.lat, req.lng], {
                    radius: 8,
                    fillColor: color,
                    color: "#fff",
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map);
                
                marker.bindPopup(`
                    <strong>T√Ωm: ${req.teamId}</strong><br>
                    ≈Ω√°dost o √∫zem√≠: ${req.territoryId}<br>
                    <button onclick="map.setView([${req.lat}, ${req.lng}], 18)">P≈ôibl√≠≈æit</button>
                `);
                
                adminRequestMarkers[req.id] = marker;
            }
        }

        // --- Map Logic ---

        const map = L.map('map').setView([50.0755, 16.310], 15);
        
        // OpenStreetMap
        const osmLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, attribution: '&copy; OpenStreetMap'
        });

        // WMS ƒå√öZK ZTM (using correct WMTS URL for Google Maps/Web Mercator projection)
        const ztmLayer = L.tileLayer('https://ags.cuzk.cz/arcgis1/rest/services/ZTM_WM/MapServer/WMTS/tile/1.0.0/ZTM_WM/default/default028mm/{z}/{y}/{x}.jpg', {
            attribution: '&copy; <a href="https://cuzk.cz">ƒå√öZK</a>',
            maxZoom: 18
        });

        // Default to ZTM (or OSM if preferred)
        ztmLayer.addTo(map);

        // Layer Control
        const baseMaps = {
            "ZTM 10 (ƒå√öZK)": ztmLayer,
            "OpenStreetMap": osmLayer
        };
        L.control.layers(baseMaps).addTo(map);

        let geoJsonLayer;
        let savedPositions = {};

        // Load saved positions first
        fetch('labels.json')
            .then(res => res.ok ? res.json() : {})
            .then(positions => {
                savedPositions = positions;
                return fetch('CTH_geo.geojson');
            })
            .then(res => {
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                return res.json();
            })
            .then(data => {
                console.log("GeoJSON loaded:", data);
                geoJsonLayer = L.geoJSON(data, {
                    style: { color: "#000", weight: 2, fillOpacity: 0.1 },
                    onEachFeature: (feature, layer) => {
                        const id = feature.properties.Text;
                        
                        // Click handler
                        layer.on('click', () => {
                            const t = globalTerritories[id];
                            const now = Date.now() / 1000;
                            
                            if (t && t.lockedUntil && t.lockedUntil > now) {
                                const remaining = Math.ceil((t.lockedUntil - now) / 60);
                                alert(`√özem√≠ ${id} je uzamƒçeno. Zb√Ωv√° ${remaining} min.`);
                                return;
                            }

                            if (currentRole === 'team') {
                                // Check if already owned by me
                                if (t && t.owner === currentUser) {
                                    alert("Toto √∫zem√≠ u≈æ m√°≈° zabran√©!");
                                    return;
                                }

                                if (confirm(`Chcete zabrat √∫zem√≠ ƒç. ${id}?`)) {
                                    requestLocationCheck(id);
                                }
                            } else {
                                alert(`√özem√≠ ${id}`);
                            }
                        });

                        // Labels
                        if (feature.geometry.type === 'Polygon' || feature.geometry.type === 'MultiPolygon') {
                            try {
                                let center;
                                
                                // 1. Try saved position
                                if (savedPositions[id]) {
                                    center = L.latLng(savedPositions[id].lat, savedPositions[id].lng);
                                } 
                                // 2. Try Polylabel
                                else {
                                    let coords = feature.geometry.coordinates;
                                    if(feature.geometry.type === 'MultiPolygon') coords = coords[0];
                                    
                                    try {
                                        const p = polylabel(coords, 0.000001);
                                        center = L.latLng(p[1], p[0]);
                                    } catch (e) {
                                        console.warn("Polylabel failed for", id, e);
                                        // 3. Fallback to center
                                        center = layer.getBounds().getCenter();
                                    }
                                }
                                
                                const marker = L.marker(center, {
                                    icon: L.divIcon({
                                        className: 'label-icon', html: id,
                                        iconSize: [24,24], iconAnchor: [12,12]
                                    }),
                                    interactive: false
                                }).addTo(map);
                                
                                territoryLabels[id] = marker;

                            } catch (err) {
                                console.error("Error creating label for feature", id, err);
                            }
                        }
                    }
                }).addTo(map);
                
                // Fit bounds
                if (geoJsonLayer.getBounds().isValid()) {
                    map.fitBounds(geoJsonLayer.getBounds());
                } else {
                    console.warn("GeoJSON bounds not valid");
                }
            })
            .catch(err => {
                console.error("Error loading GeoJSON:", err);
                alert("Nepoda≈ôilo se naƒç√≠st mapu √∫zem√≠: " + err.message);
            });

        function updateTerritoryLabels() {
            const now = Date.now() / 1000;
            
            for (const id in territoryLabels) {
                const marker = territoryLabels[id];
                const t = globalTerritories[id];
                let isLocked = false;
                
                if (t && t.lockedUntil && t.lockedUntil > now) {
                    isLocked = true;
                }
                
                // Only update if needed to avoid flickering/reflows (optional optimization)
                // But Leaflet's setIcon is reasonably fast.
                
                if (isLocked) {
                    marker.setIcon(L.divIcon({
                        className: 'label-icon locked',
                        html: 'üîí', // Lock icon
                        iconSize: [24,24],
                        iconAnchor: [12,12]
                    }));
                } else {
                    marker.setIcon(L.divIcon({
                        className: 'label-icon',
                        html: id,
                        iconSize: [24,24],
                        iconAnchor: [12,12]
                    }));
                }
            }
        }

        function updateMapColors(territoryState) {
            if (!geoJsonLayer) return;
            
            // teamColors moved to global scope

            geoJsonLayer.eachLayer(layer => {
                const id = layer.feature.properties.Text;
                if (territoryState[id]) {
                    const owner = territoryState[id].owner;
                    layer.setStyle({
                        fillColor: teamColors[owner] || '#333',
                        fillOpacity: 0.5,
                        color: teamColors[owner] || '#000',
                        weight: 3
                    });
                }
            });
        }
    </script>
</body>
</html>
